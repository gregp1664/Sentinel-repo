{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
    "parameters": {
      "playbookPrefix": {
      "type": "string",
      "minLength": 3,
      "maxLength": 22
    },
      "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
        "resourceTags": {
        "type": "object",
        "defaultValue": {
            "Environment": "Cyber",
            "Project": "Tutorial"
        }
    }
  },
    "variables": {
    "uniquePlaybookName": "[concat(parameters('playbookPrefix'), uniqueString(resourceGroup().id))]"
  },
"resources": [
{
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[variables('uniquePlaybookName')]",
            "location": "[parameters('location')]",
            "tags": "[parameters('resourceTags')]",
            "properties": {
                "state": "Enabled",
    "definition": {
        "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
        "actions": {
            "Acknowledge": {
                "cases": {
                    "Acknowledge": {
                        "actions": {
                            "API_Ticket_Update_SOC_Analsyst_": {
                                "inputs": {
                                    "body": {
                                        "actionType": {
                                            "resolvingParameters": [
                                                {
                                                    "parameterName": "shortCode",
                                                    "parameterValue": "INVESTIGATE"
                                                }
                                            ]
                                        },
                                        "eventId": "@{outputs('Ticket_ID')}",
                                        "remarks": "SOC Analyst Investigating: @{body('Create_an_Acknowledge_button_for_Analyst')?['responder']?['displayName']}"
                                    },
                                    "headers": {
                                        "Accept": "application/json",
                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                        "Content-Type": "application/json"
                                    },
                                    "method": "POST",
                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                },
                                "runAfter": {
                                    "Add_labels_to_incident": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Http"
                            },
                            "Add_comment_to_incident": {
                                "inputs": {
                                    "body": {
                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                        "message": "<p>Assyst Ticket: @{outputs('Ticket_Number_eventRef')}</p>"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                },
                                "runAfter": {},
                                "type": "ApiConnection"
                            },
                            "Add_comment_to_incident_6": {
                                "inputs": {
                                    "body": {
                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                        "message": "<p>Analyst Investigating: &nbsp;@{body('Create_an_Acknowledge_button_for_Analyst')?['responder']?['displayName']}</p>"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                },
                                "runAfter": {
                                    "Add_comment_to_incident": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Add_labels_to_incident": {
                                "inputs": {
                                    "body": {
                                        "Labels": [
                                            {
                                                "Label": "Analyst Investigating:  @{body('Create_an_Acknowledge_button_for_Analyst')?['responder']?['displayName']}"
                                            },
                                            {
                                                "Label": "Ticket: @{outputs('Ticket_Number_eventRef')}   "
                                            }
                                        ]
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/AddLabels"
                                },
                                "runAfter": {
                                    "Change_incident_status": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Change_incident_status": {
                                "inputs": {
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('InProgress')}"
                                },
                                "runAfter": {
                                    "Add_comment_to_incident_6": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            }
                        },
                        "case": "Acknowledge"
                    }
                },
                "default": {
                    "actions": {}
                },
                "expression": "@body('Create_an_Acknowledge_button_for_Analyst')['submitActionId']",
                "runAfter": {
                    "Create_an_Acknowledge_button_for_Analyst": [
                        "Succeeded"
                    ]
                },
                "type": "Switch"
            },
            "Alert_-_Get_IPs": {
                "inputs": {
                    "body": "@triggerBody()?['Entities']",
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                        }
                    },
                    "method": "post",
                    "path": "/entities/ip"
                },
                "runAfter": {
                    "Alert_-_Get_URLs": [
                        "Succeeded"
                    ]
                },
                "type": "ApiConnection"
            },
            "Alert_-_Get_URLs": {
                "inputs": {
                    "body": "@triggerBody()?['Entities']",
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                        }
                    },
                    "method": "post",
                    "path": "/entities/url"
                },
                "runAfter": {
                    "Alert_-_Get_accounts": [
                        "Succeeded"
                    ]
                },
                "type": "ApiConnection"
            },
            "Alert_-_Get_accounts": {
                "inputs": {
                    "body": "@triggerBody()?['Entities']",
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                        }
                    },
                    "method": "post",
                    "path": "/entities/account"
                },
                "runAfter": {},
                "type": "ApiConnection"
            },
            "Alert_-_Get_hosts": {
                "inputs": {
                    "body": "@triggerBody()?['Entities']",
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                        }
                    },
                    "method": "post",
                    "path": "/entities/host"
                },
                "runAfter": {
                    "Alert_-_Get_IPs": [
                        "Succeeded"
                    ]
                },
                "type": "ApiConnection"
            },
            "Alert_-_Get_incident": {
                "inputs": {
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                        }
                    },
                    "method": "get",
                    "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                },
                "runAfter": {
                    "Alert_-_Get_hosts": [
                        "Succeeded"
                    ]
                },
                "type": "ApiConnection"
            },
            "Analyst_decision_process_(True_-_False_Positive_or_escalate)": {
                "inputs": {
                    "body": {
                        "body": {
                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Cause of  Alert:\",\n    },\n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"Classification\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"Unknown\",\n          \"value\": \"Unknown\"\n    },\n    {\n          \"title\": \"N/A\",\n          \"value\": \"N/A\"\n    },\n    {\n          \"title\": \"Hardware / Software Failure\",\n          \"value\": \"Hardware / Software Failure\"\n    },\n    {\n          \"title\": \"User Error\",\n          \"value\": \"User Error\"\n    },\n    {\n          \"title\": \"Expected Behaviour\",\n          \"value\": \"Expected Behaviour\"\n    },\n    {\n          \"title\": \"Rule Missfire\",\n          \"value\": \"Rule Missfire\"\n    },\n    {\n          \"title\": \"Scan\",\n          \"value\": \"Scan\"\n    },\n    {\n          \"title\": \"Misconfiguration\",\n          \"value\": \"Misconfiguration\"\n    },\n    {\n          \"title\": \"Ransomware\",\n          \"value\": \"Ransomware\"\n    },\n    {\n          \"title\": \"Phishing\",\n          \"value\": \"Phishing\"\n    },\n    {\n          \"title\": \"Adware / PUP\",\n          \"value\": \"Adware / PUP\"\n    },\n    {\n          \"title\": \"Exfiltration\",\n          \"value\": \"Exfiltration\"\n    },\n    {\n          \"title\": \"Data Leak\",\n          \"value\": \"Data Leak\"\n    },\n    {\n          \"title\": \"Key Logger\",\n          \"value\": \"Key Logger\"\n    },\n    {\n          \"title\": \"DDoS\",\n          \"value\": \"DDoS\"\n    },\n  {\n          \"title\": \"C2\",\n          \"value\": \"C2\"\n    },    {\n          \"title\": \"Privilege Escalation\",\n          \"value\": \"Privilege Escalation\"\n    },\n    {\n          \"title\": \"Rogue AP\",\n          \"value\": \"Rogue AP\"\n    }\n]\n},\n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Additional Information\"\n    },\n    {\n    \"type\": \"Input.Text\",\n    \"id\":  \"Additional Info\",\n    \"placeholder\":  \"Additional Information\",\n    \"maxLength\": 2000,\n    \"isMultiline\": true\n    }\n],\n\"actions\": [\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"True Positive\",\n    },\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"False Positive\",\n    },\n  {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Benign Positive\",\n    },\n  {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Escalate\",\n    },\n  {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Assign to another department\",\n    },\n]\n}",
                            "recipient": {
                                "to": "@{body('Create_an_Acknowledge_button_for_Analyst')?['responder']?['email']}"
                            }
                        },
                        "notificationUrl": "@{listCallbackUrl()}"
                    },
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                        }
                    },
                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                },
                "runAfter": {
                    "Acknowledge": [
                        "Succeeded"
                    ]
                },
                "type": "ApiConnectionWebhook"
            },
            "Create_an_Acknowledge_button_for_Analyst": {
                "inputs": {
                    "body": {
                        "body": {
                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n],\n\"actions\": [\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Acknowledge\",\n    },\n]\n}",
                            "recipient": {
                                "channelId": "19:8e9a2ddff71c486088cbaa0aab11bf17@thread.tacv2"
                            }
                        },
                        "notificationUrl": "@{listCallbackUrl()}"
                    },
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                        }
                    },
                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/channel/$subscriptions",
                    "queries": {
                        "groupId": "962921e2-8342-4caa-ae1f-bf13653bfaaa"
                    }
                },
                "runAfter": {
                    "Ticket_Number_eventRef": [
                        "Succeeded"
                    ]
                },
                "type": "ApiConnectionWebhook"
            },
            "HTTP": {
                "inputs": {
                    "headers": {
                        "Accept": "application/json",
                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                        "Content-Type": "application/json"
                    },
                    "method": "GET",
                    "uri": "https://servicedesk.allpay.net/assystREST/v2/events?eventStatus=open&eventType=incident&shortDescription[like]=AP200-Sentinel%20DSS%20-%20Alert%20ID%20-%20@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}%20Severity%20-%20@{body('Alert_-_Get_incident')?['properties']?['severity']}"
                },
                "runAfter": {
                    "Alert_-_Get_incident": [
                        "Succeeded"
                    ]
                },
                "type": "Http"
            },
            "Ticket_ID": {
                "inputs": "@body('HTTP')[0]['Id']",
                "runAfter": {
                    "HTTP": [
                        "Succeeded"
                    ]
                },
                "type": "Compose"
            },
            "Ticket_Number_eventRef": {
                "inputs": "@body('HTTP')[0]['eventRef']",
                "runAfter": {
                    "Ticket_ID": [
                        "Succeeded"
                    ]
                },
                "type": "Compose"
            },
            "True,_False,_Benign,_Escalate_or_Assign": {
                "cases": {
                    "Assign_to_another_department": {
                        "actions": {
                            "API_Update_Assign_Ticket": {
                                "inputs": {
                                    "body": {
                                        "actionType": {
                                            "resolvingParameters": [
                                                {
                                                    "parameterName": "shortCode",
                                                    "parameterValue": "INVESTIGATE"
                                                }
                                            ]
                                        },
                                        "eventId": "@{outputs('Ticket_ID')}",
                                        "remarks": "Analyst: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['responder']?['displayName']}\nAnalyst Decision: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']}\nAnalyst Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}\n\nAnalsyt Reason for Closure: \n\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}"
                                    },
                                    "headers": {
                                        "Accept": "application/json",
                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                        "Content-Type": "application/json"
                                    },
                                    "method": "POST",
                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                },
                                "runAfter": {
                                    "Change_incident_status_8": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Http"
                            },
                            "Add_comment_to_incident_(V2)_6": {
                                "inputs": {
                                    "body": {
                                        "Value": "This alert has been assigned to @{body('Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response')?['data']?['assign to another Department']} to Investigate. "
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}"
                                },
                                "runAfter": {
                                    "Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Add_rows_to_a_dataset_7": {
                                "inputs": {
                                    "body": {
                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                        "Alert Source": "AP200-Sentinel-DSS",
                                        "Analyst Classification": "@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}",
                                        "Assigned department": " @{body('Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response')?['data']?['assign to another Department']}",
                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                        "False / True Positive": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']",
                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                    "queries": {
                                        "pbi_source": "powerAutomate"
                                    }
                                },
                                "runAfter": {
                                    "API_Update_Assign_Ticket": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Assign_To_Devs,_Architects_and_Other_Members_of_the_company": {
                                "cases": {
                                    "Architects": {
                                        "actions": {
                                            "API_Close_Ticket_and_list_Work_Item_ID_Architects": {
                                                "inputs": {
                                                    "body": {
                                                        "actionType": {
                                                            "resolvingParameters": [
                                                                {
                                                                    "parameterName": "shortCode",
                                                                    "parameterValue": "CLOSURE"
                                                                }
                                                            ]
                                                        },
                                                        "causeCategoryId": "338",
                                                        "causeItemId": "4060",
                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                        "remarks": "Assigned: @{body('Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response')?['data']?['assign to another Department']}\nWork Item ID: @{body('Create_a_work_item')?['id']}\nWork Item Link: @{body('Create_a_work_item')?['url']}\nSentinel Alert ID: \nAssyst Ticket: @{outputs('Ticket_Number_eventRef')}"
                                                    },
                                                    "headers": {
                                                        "Accept": "application/json",
                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                        "Content-Type": "application/json"
                                                    },
                                                    "method": "POST",
                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                },
                                                "runAfter": {
                                                    "Create_a_work_item": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http"
                                            },
                                            "Create_a_work_item": {
                                                "inputs": {
                                                    "body": {
                                                        "area": "allpay\\Architecture",
                                                        "description": "<b>As</b> allpay\n<br>\n<br>\n<b>Alert Description:</b> \n<br>\n<br>\n<b>URL:</b> \n<br>\n<br>\n<b>Investigation Summary:</b> @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}",
                                                        "dynamicFields": {
                                                            "System.Tags": "Assyst Ticket: @{outputs('Ticket_Number_eventRef')}; Sentinel ID: "
                                                        },
                                                        "title": " - Alert ID "
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['visualstudioteamservices_1']['connectionId']"
                                                        }
                                                    },
                                                    "method": "patch",
                                                    "path": "/@{encodeURIComponent('allpay')}/_apis/wit/workitems/$@{encodeURIComponent('Product Backlog Item')}",
                                                    "queries": {
                                                        "account": "allpay-vs-001"
                                                    }
                                                },
                                                "runAfter": {},
                                                "type": "ApiConnection"
                                            }
                                        },
                                        "case": "Architects"
                                    },
                                    "Devs": {
                                        "actions": {
                                            "API_Close_Ticlet_and_list_Work_Item_ID_Devs": {
                                                "inputs": {
                                                    "body": {
                                                        "actionType": {
                                                            "resolvingParameters": [
                                                                {
                                                                    "parameterName": "shortCode",
                                                                    "parameterValue": "CLOSURE"
                                                                }
                                                            ]
                                                        },
                                                        "causeCategoryId": "338",
                                                        "causeItemId": "4060",
                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                        "remarks": "Assigned: @{body('Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response')?['data']?['assign to another Department']}\nWork Item ID: @{body('Create_a_work_item_2')?['id']}\nWork Item Link: @{body('Create_a_work_item_2')?['url']}\nSentinel Alert ID: \nAssyst Ticket: @{outputs('Ticket_Number_eventRef')}"
                                                    },
                                                    "headers": {
                                                        "Accept": "application/json",
                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                        "Content-Type": "application/json"
                                                    },
                                                    "method": "POST",
                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                },
                                                "runAfter": {
                                                    "Create_a_work_item_2": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http"
                                            },
                                            "Create_a_work_item_2": {
                                                "inputs": {
                                                    "body": {
                                                        "area": "allpay\\Cyber Security",
                                                        "description": "<b>As</b> allpay\n<br>\n<br>\n<b>Alert Description:</b> \n<br>\n<br>\n<b>URL:</b> \n<br>\n<br>\n<b>Investigation Summary:</b> @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}",
                                                        "dynamicFields": {
                                                            "System.Tags": "Assyst Ticket: @{outputs('Ticket_Number_eventRef')}; Sentinel ID: "
                                                        },
                                                        "title": " - Alert ID "
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['visualstudioteamservices_1']['connectionId']"
                                                        }
                                                    },
                                                    "method": "patch",
                                                    "path": "/@{encodeURIComponent('allpay')}/_apis/wit/workitems/$@{encodeURIComponent('Product Backlog Item')}",
                                                    "queries": {
                                                        "account": "allpay-vs-001"
                                                    }
                                                },
                                                "runAfter": {},
                                                "type": "ApiConnection"
                                            }
                                        },
                                        "case": "Devs"
                                    }
                                },
                                "default": {
                                    "actions": {
                                        "API_Assign_Ticket": {
                                            "inputs": {
                                                "body": {
                                                    "actionType": {
                                                        "resolvingParameters": [
                                                            {
                                                                "parameterName": "shortCode",
                                                                "parameterValue": "ASSIGN"
                                                            }
                                                        ]
                                                    },
                                                    "assignedServDeptId": "@{body('Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response')?['data']?['assign to another Department']}",
                                                    "eventId": "@{outputs('Ticket_ID')}",
                                                    "remarks": "@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}"
                                                },
                                                "headers": {
                                                    "Accept": "application/json",
                                                    "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                    "Content-Type": "application/json"
                                                },
                                                "method": "POST",
                                                "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                            },
                                            "runAfter": {},
                                            "type": "Http"
                                        }
                                    }
                                },
                                "expression": "@body('Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response')?['data']?['assign to another Department']",
                                "runAfter": {
                                    "Add_rows_to_a_dataset_7": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Switch"
                            },
                            "Change_incident_status_8": {
                                "inputs": {
                                    "body": {
                                        "CloseReason": "FalsePositive",
                                        "CloseReasonText": "Assigned to @{body('Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response')?['data']?['assign to another Department']}"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('Closed')}"
                                },
                                "runAfter": {
                                    "Add_comment_to_incident_(V2)_6": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Post_an_Adaptive_Card_to_a_Teams_user_and_wait_for_a_response": {
                                "inputs": {
                                    "body": {
                                        "body": {
                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"Assign to another Department\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"Infrastructure\",\n          \"value\": \"32\"\n    },\n    {\n          \"title\": \"Service Desk\",\n          \"value\": \"1\"\n    },\n    {\n          \"title\": \"App Support\",\n          \"value\": \"4\"\n    },\n    {\n          \"title\": \"Networks\",\n          \"value\": \"16\"\n    },\n    {\n          \"title\": \"Dev\",\n          \"value\": \"Devs\"\n    },\n    {\n          \"title\": \"Bureau Support\",\n          \"value\": \"30\"\n    },\n    {\n          \"title\": \"Architects\",\n          \"value\": \"Architects\"\n    },\n],\n},\n],\n\"actions\": [\n\t{\n    \"type\": \"Action.Submit\",\n    \"title\": \"Assign to another department\",\n    },\n]\n}",
                                            "recipient": {
                                                "to": "@body('Create_an_Acknowledge_button_for_Analyst')?['responder']?['email']"
                                            }
                                        },
                                        "notificationUrl": "@{listCallbackUrl()}"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                        }
                                    },
                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                },
                                "runAfter": {},
                                "type": "ApiConnectionWebhook"
                            }
                        },
                        "case": "Assign to another department"
                    },
                    "Benign_Positive": {
                        "actions": {
                            "API_Close_Ticket": {
                                "inputs": {
                                    "body": {
                                        "actionType": {
                                            "resolvingParameters": [
                                                {
                                                    "parameterName": "shortCode",
                                                    "parameterValue": "CLOSURE"
                                                }
                                            ]
                                        },
                                        "causeCategoryId": "338",
                                        "causeItemId": "4060",
                                        "eventId": "@{outputs('Ticket_ID')}",
                                        "remarks": "Analyst: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['responder']?['displayName']}\nAnalyst Decision: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']}\nAnalyst Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}\n\nAnalsyt Reason for Closure: \n\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}"
                                    },
                                    "headers": {
                                        "Accept": "application/json",
                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                        "Content-Type": "application/json"
                                    },
                                    "method": "POST",
                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                },
                                "runAfter": {
                                    "Add_comment_to_incident_5": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Http"
                            },
                            "Add_comment_to_incident_5": {
                                "inputs": {
                                    "body": {
                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                        "message": "<p><br>\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}<br>\n</p>"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                },
                                "runAfter": {
                                    "Change_incident_status_2": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Add_rows_to_a_dataset": {
                                "inputs": {
                                    "body": {
                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                        "Alert Source": "AP200-Sentinel-DSS",
                                        "Analyst Classification": "@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}",
                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                        "False / True Positive": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']",
                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                    "queries": {
                                        "pbi_source": "powerAutomate"
                                    }
                                },
                                "runAfter": {
                                    "API_Close_Ticket": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Change_incident_status_2": {
                                "inputs": {
                                    "body": {
                                        "CloseReason": "BenignPositive",
                                        "CloseReasonText": "Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}  "
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('Closed')}"
                                },
                                "runAfter": {},
                                "type": "ApiConnection"
                            }
                        },
                        "case": "Benign Positive"
                    },
                    "Escalate": {
                        "actions": {
                            "API_Update_Ticket_with_assigned_analyst": {
                                "inputs": {
                                    "body": {
                                        "actionType": {
                                            "resolvingParameters": [
                                                {
                                                    "parameterName": "shortCode",
                                                    "parameterValue": "INVESTIGATE"
                                                }
                                            ]
                                        },
                                        "eventId": "@{outputs('Ticket_ID')}",
                                        "remarks": "Analyst: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['responder']?['displayName']}\nAnalyst Decision: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']}\nAnalyst Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}\nEscalted to: @{body('Select_the_analyst_to_be_escalated_to')?['data']?['escalation']}\n\nAnalsyt Reason for Escalation: \n\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}"
                                    },
                                    "headers": {
                                        "Accept": "application/json",
                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                        "Content-Type": "application/json"
                                    },
                                    "method": "POST",
                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                },
                                "runAfter": {
                                    "Select_the_analyst_to_be_escalated_to": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Http"
                            },
                            "Add_comment_to_incident_(V2)_4": {
                                "inputs": {
                                    "body": {
                                        "Value": "@{body('Select_the_analyst_to_be_escalated_to')?['data']?['escalation']}This incident has been escalated to  for further investigation."
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}"
                                },
                                "runAfter": {
                                    "Add_labels_to_incident_2": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Add_labels_to_incident_2": {
                                "inputs": {
                                    "body": {
                                        "Labels": [
                                            {
                                                "Label": "Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}"
                                            },
                                            {
                                                "Label": "Escalated to: @{body('Select_the_analyst_to_be_escalated_to')?['data']?['escalation']}"
                                            }
                                        ]
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/AddLabels"
                                },
                                "runAfter": {
                                    "API_Update_Ticket_with_assigned_analyst": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Assigned_User_Acknowledgemnet_of_Incident_Investigation": {
                                "cases": {
                                    "Acknowledge": {
                                        "actions": {
                                            "API_Update_Ticket_with_assigned_Acknowledgement_of_Analyst": {
                                                "inputs": {
                                                    "body": {
                                                        "actionType": {
                                                            "resolvingParameters": [
                                                                {
                                                                    "parameterName": "shortCode",
                                                                    "parameterValue": "INVESTIGATE"
                                                                }
                                                            ]
                                                        },
                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                        "remarks": "Acknowlegement: \nAnalyst: @{body('Mesage_to_Analyst_assigned_incident_for_further_investigation')?['responder']?['displayName']}"
                                                    },
                                                    "headers": {
                                                        "Accept": "application/json",
                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                        "Content-Type": "application/json"
                                                    },
                                                    "method": "POST",
                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions?"
                                                },
                                                "runAfter": {
                                                    "Update_Sentinel_Incident": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http"
                                            },
                                            "False,_Benign,_True_Positive_Decision": {
                                                "cases": {
                                                    "Assign_to_another_department": {
                                                        "actions": {
                                                            "API_Update_Assign_Ticket_2": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "actionType": {
                                                                            "resolvingParameters": [
                                                                                {
                                                                                    "parameterName": "shortCode",
                                                                                    "parameterValue": "INVESTIGATE"
                                                                                }
                                                                            ]
                                                                        },
                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                        "remarks": "Analyst: @{body('True,_False,_Benign_or_Assign')?['responder']?['displayName']}\nAnalyst Decision: @{body('True,_False,_Benign_or_Assign')['submitActionId']}\nAnalyst Classification: @{body('True,_False,_Benign_or_Assign')?['data']?['classification']}\n\nAnalsyt Reason for Assigning to another department: \n\n@{body('True,_False,_Benign_or_Assign')?['data']?['additional Info']}"
                                                                    },
                                                                    "headers": {
                                                                        "Accept": "application/json",
                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                        "Content-Type": "application/json"
                                                                    },
                                                                    "method": "POST",
                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                },
                                                                "runAfter": {
                                                                    "Change_incident_status_9": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Http"
                                                            },
                                                            "API_to_Assign_to_another_department_2": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "actionType": {
                                                                            "resolvingParameters": [
                                                                                {
                                                                                    "parameterName": "shortCode",
                                                                                    "parameterValue": "ASSIGN"
                                                                                }
                                                                            ]
                                                                        },
                                                                        "assignedServDeptId": "@{body('Assign_to_a_Department_2')?['data']?['assign to another Department']}",
                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                        "remarks": "@{body('True,_False,_Benign_or_Assign')?['data']?['additional Info']}"
                                                                    },
                                                                    "headers": {
                                                                        "Accept": "application/json",
                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                        "Content-Type": "application/json"
                                                                    },
                                                                    "method": "POST",
                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                },
                                                                "runAfter": {
                                                                    "Add_rows_to_a_dataset_5": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Http"
                                                            },
                                                            "Add_rows_to_a_dataset_5": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                                                        "Alert Source": "AP200-Sentinel-DSS",
                                                                        "Analyst Classification - Sentinel": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']",
                                                                        "Assigned department": " @{body('Assign_to_a_Department_2')?['data']?['assign to another Department']}",
                                                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                                                        "False / True Positive": "@body('True,_False,_Benign_or_Assign')['submitActionId']",
                                                                        "Response Time": "@body('True,_False,_Benign_or_Assign')['responseTime']",
                                                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                                                    "queries": {
                                                                        "pbi_source": "powerAutomate"
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "API_Update_Assign_Ticket_2": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection"
                                                            },
                                                            "Assign_to_a_Department_2": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "body": {
                                                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"Assign to another Department\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"Infrastructure\",\n          \"value\": \"32\"\n    },\n    {\n          \"title\": \"Service Desk\",\n          \"value\": \"1\"\n    },\n    {\n          \"title\": \"App Support\",\n          \"value\": \"4\"\n    },\n    {\n          \"title\": \"Networks\",\n          \"value\": \"16\"\n    },\n    {\n          \"title\": \"Dev\",\n          \"value\": \"10\"\n    },\n    {\n          \"title\": \"Bureau Support\",\n          \"value\": \"30\"\n    },\n],\n},\n],\n\"actions\": [\n\t{\n    \"type\": \"Action.Submit\",\n    \"title\": \"Assign to another department\",\n    },\n]\n}",
                                                                            "recipient": {
                                                                                "to": "@body('True,_False,_Benign_or_Assign')?['responder']?['email']"
                                                                            }
                                                                        },
                                                                        "notificationUrl": "@{listCallbackUrl()}"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                                                        }
                                                                    },
                                                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                                                },
                                                                "runAfter": {},
                                                                "type": "ApiConnectionWebhook"
                                                            },
                                                            "Change_incident_status_9": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "CloseReason": "FalsePositive",
                                                                        "CloseReasonText": "Assigned to  @{body('Assign_to_a_Department_2')?['data']?['assign to another Department']} for investigation"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('Closed')}"
                                                                },
                                                                "runAfter": {
                                                                    "Update_Sentinel_with_Assigned_Department_2": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection"
                                                            },
                                                            "Update_Sentinel_with_Assigned_Department_2": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "Value": "This alert has been assigned to   @{body('Assign_to_a_Department_2')?['data']?['assign to another Department']}to Investigate. "
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}"
                                                                },
                                                                "runAfter": {
                                                                    "Assign_to_a_Department_2": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection"
                                                            }
                                                        },
                                                        "case": "Assign to another department"
                                                    },
                                                    "Benign_Positive": {
                                                        "actions": {
                                                            "API_to_Close_Escalated_Incident_Benign_Positive_": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "actionType": {
                                                                            "resolvingParameters": [
                                                                                {
                                                                                    "parameterName": "shortCode",
                                                                                    "parameterValue": "CLOSURE"
                                                                                }
                                                                            ]
                                                                        },
                                                                        "causeCategoryId": "338",
                                                                        "causeItemId": "4060",
                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                        "remarks": "Analyst: @{body('True,_False,_Benign_or_Assign')?['responder']?['displayName']}\nAnalyst Decision: @{body('True,_False,_Benign_or_Assign')['submitActionId']}\nAnalyst Classification: @{body('True,_False,_Benign_or_Assign')?['data']?['classification']}\n\nAdditional Information: \n@{body('True,_False,_Benign_or_Assign')?['data']?['additional Info']}"
                                                                    },
                                                                    "headers": {
                                                                        "Accept": "application/json",
                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                        "Content-Type": "application/json"
                                                                    },
                                                                    "method": "POST",
                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                },
                                                                "runAfter": {
                                                                    "Update_Incident_with_Analsyst_Findings": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Http"
                                                            },
                                                            "Update_Incident_with_Analsyst_Findings": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                                        "message": "<p>Addiional Information:<br>\n@{body('True,_False,_Benign_or_Assign')?['data']?['additional Info']}</p>"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "path": "/Incidents/Comment"
                                                                },
                                                                "runAfter": {
                                                                    "Update_incident_status_to_be_closed_Benign_Positive": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection"
                                                            },
                                                            "Update_PowerBi_Data": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                                                        "Alert Source": "AP200-Sentinel-DSS",
                                                                        "Analyst Classification - Sentinel": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']",
                                                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                                                        "False / True Positive": "@body('True,_False,_Benign_or_Assign')['submitActionId']",
                                                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                                                    "queries": {
                                                                        "pbi_source": "powerAutomate"
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "API_to_Close_Escalated_Incident_Benign_Positive_": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection"
                                                            },
                                                            "Update_incident_status_to_be_closed_Benign_Positive": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "CloseReason": "BenignPositive",
                                                                        "CloseReasonText": "Classification:  @{body('True,_False,_Benign_or_Assign')?['data']?['classification']}\n"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('Closed')}"
                                                                },
                                                                "runAfter": {},
                                                                "type": "ApiConnection"
                                                            }
                                                        },
                                                        "case": "Benign Positive"
                                                    },
                                                    "False_Positive": {
                                                        "actions": {
                                                            "API_to_Close_Escalated_Incident_False_Positive_": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "actionType": {
                                                                            "resolvingParameters": [
                                                                                {
                                                                                    "parameterName": "shortCode",
                                                                                    "parameterValue": "CLOSURE"
                                                                                }
                                                                            ]
                                                                        },
                                                                        "causeCategoryId": "338",
                                                                        "causeItemId": "4060",
                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                        "remarks": "Analyst: @{body('True,_False,_Benign_or_Assign')?['responder']?['displayName']}\nAnalyst Decision: @{body('True,_False,_Benign_or_Assign')['submitActionId']}\nAnalyst Classification: @{body('True,_False,_Benign_or_Assign')?['data']?['classification']}\n\nAdditional Information: \n@{body('True,_False,_Benign_or_Assign')?['data']?['additional Info']}"
                                                                    },
                                                                    "headers": {
                                                                        "Accept": "application/json",
                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                        "Content-Type": "application/json"
                                                                    },
                                                                    "method": "POST",
                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                },
                                                                "runAfter": {
                                                                    "Update_Incident_with_Analyst_Findings_False_Positive": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Http"
                                                            },
                                                            "Update_Incident_with_Analyst_Findings_False_Positive": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                                        "message": "<p><br>\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}</p>"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "path": "/Incidents/Comment"
                                                                },
                                                                "runAfter": {
                                                                    "Update_incident_status_to_be_closed_False_Positive": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection"
                                                            },
                                                            "Update_PowerBi_Data_False_Positive": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                                                        "Alert Source": "AP200-Sentinel-DSS",
                                                                        "Analyst Classification - Sentinel": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']",
                                                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                                                        "False / True Positive": "@body('True,_False,_Benign_or_Assign')['submitActionId']",
                                                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                                                    "queries": {
                                                                        "pbi_source": "powerAutomate"
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "API_to_Close_Escalated_Incident_False_Positive_": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection"
                                                            },
                                                            "Update_incident_status_to_be_closed_False_Positive": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "CloseReason": "FalsePositive",
                                                                        "CloseReasonText": "Ticket:   Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}  Addiional "
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('Closed')}"
                                                                },
                                                                "runAfter": {},
                                                                "type": "ApiConnection"
                                                            }
                                                        },
                                                        "case": "False Positive"
                                                    },
                                                    "True_Positive": {
                                                        "actions": {
                                                            "API_to_Update_Escalated_Incident_True_Positive_": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "actionType": {
                                                                            "resolvingParameters": [
                                                                                {
                                                                                    "parameterName": "shortCode",
                                                                                    "parameterValue": "INVESTIGATE"
                                                                                }
                                                                            ]
                                                                        },
                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                        "remarks": "Analyst: @{body('True,_False,_Benign_or_Assign')?['responder']?['displayName']}\nAnalyst Decision: @{body('True,_False,_Benign_or_Assign')['submitActionId']}\nAnalyst Classification: @{body('True,_False,_Benign_or_Assign')?['data']?['classification']}\n\nAdditional Information: \n@{body('True,_False,_Benign_or_Assign')?['data']?['additional Info']}"
                                                                    },
                                                                    "headers": {
                                                                        "Accept": "application/json",
                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                        "Content-Type": "application/json"
                                                                    },
                                                                    "method": "POST",
                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                },
                                                                "runAfter": {
                                                                    "Update_Incident_with_Analyst_Findings_True_Positive": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Http"
                                                            },
                                                            "Add_labels_to_incident_True_Positive": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "Labels": [
                                                                            {
                                                                                "Label": "@body('True,_False,_Benign_or_Assign')?['data']?['classification']"
                                                                            },
                                                                            {
                                                                                "Label": "@body('True,_False,_Benign_or_Assign')['submitActionId']"
                                                                            },
                                                                            {
                                                                                "Label": null
                                                                            }
                                                                        ]
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/AddLabels"
                                                                },
                                                                "runAfter": {},
                                                                "type": "ApiConnection"
                                                            },
                                                            "Close_or_Request_CSIRT_Assistance": {
                                                                "cases": {
                                                                    "Close": {
                                                                        "actions": {
                                                                            "API_to_Close_Escalated_Incident_True_Positive2_": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "actionType": {
                                                                                            "resolvingParameters": [
                                                                                                {
                                                                                                    "parameterName": "shortCode",
                                                                                                    "parameterValue": "CLOSURE"
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        "causeCategoryId": "338",
                                                                                        "causeItemId": "4060",
                                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                                        "remarks": "Analyst: @{body('True,_False,_Benign_or_Assign')?['responder']?['displayName']}\nAnalyst Decision: @{body('True,_False,_Benign_or_Assign')['submitActionId']}\nAnalyst Classification: @{body('True,_False,_Benign_or_Assign')?['data']?['classification']}\n\nAdditional Information: \n@{body('True,_False,_Benign_or_Assign')?['data']?['additional Info']}\n\n@{body('Ticket_Closure_or_CSIRT_assistance_request')?['data']?['ticket Update']}"
                                                                                    },
                                                                                    "headers": {
                                                                                        "Accept": "application/json",
                                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                                        "Content-Type": "application/json"
                                                                                    },
                                                                                    "method": "POST",
                                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                                },
                                                                                "runAfter": {
                                                                                    "Update_Incident_with_Analyst_Findings_True_Positive2": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Http"
                                                                            },
                                                                            "Update_Incident_with_Analyst_Findings_True_Positive2": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                                                        "message": "<p>@{body('Ticket_Closure_or_CSIRT_assistance_request')?['data']?['ticket Update']}</p>"
                                                                                    },
                                                                                    "host": {
                                                                                        "connection": {
                                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                        }
                                                                                    },
                                                                                    "method": "post",
                                                                                    "path": "/Incidents/Comment"
                                                                                },
                                                                                "runAfter": {
                                                                                    "Update_incident_status_to_be_closed_True_Positive": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "ApiConnection"
                                                                            },
                                                                            "Update_PowerBi_Data_True_Positive2": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                                                                        "Alert Source": "AP200-Sentinel-DSS",
                                                                                        "Analyst Classification - Sentinel": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']",
                                                                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                                                                        "False / True Positive": "@body('True,_False,_Benign_or_Assign')['submitActionId']",
                                                                                        "Response Time": "@body('Mesage_to_Analyst_assigned_incident_for_further_investigation')['responseTime']",
                                                                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                                                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                                                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                                                                    },
                                                                                    "host": {
                                                                                        "connection": {
                                                                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                                                                        }
                                                                                    },
                                                                                    "method": "post",
                                                                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                                                                    "queries": {
                                                                                        "pbi_source": "powerAutomate"
                                                                                    }
                                                                                },
                                                                                "runAfter": {
                                                                                    "API_to_Close_Escalated_Incident_True_Positive2_": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "ApiConnection"
                                                                            },
                                                                            "Update_incident_status_to_be_closed_True_Positive": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "CloseReason": "TruePositive",
                                                                                        "CloseReasonText": "Classification: @{body('True,_False,_Benign_or_Assign')?['data']?['classification']}"
                                                                                    },
                                                                                    "host": {
                                                                                        "connection": {
                                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                        }
                                                                                    },
                                                                                    "method": "put",
                                                                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('Closed')}"
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "ApiConnection"
                                                                            }
                                                                        },
                                                                        "case": "Close"
                                                                    },
                                                                    "Require_CSIRT": {
                                                                        "actions": {
                                                                            "API_to_Investigate_Escalated_Incident_CSIRT_Required_2_": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "actionType": {
                                                                                            "resolvingParameters": [
                                                                                                {
                                                                                                    "parameterName": "shortCode",
                                                                                                    "parameterValue": "INVESTIGATE"
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                                        "remarks": "Analyst: @{body('True,_False,_Benign_or_Assign')?['responder']?['displayName']}\nAnalyst Decision: @{body('True,_False,_Benign_or_Assign')['submitActionId']}\nAnalyst Classification: @{body('True,_False,_Benign_or_Assign')?['data']?['classification']}\n\nAdditional Information: \n@{body('True,_False,_Benign_or_Assign')?['data']?['additional Info']}\n\n@{body('Ticket_Closure_or_CSIRT_assistance_request')?['data']?['ticket Update']}"
                                                                                    },
                                                                                    "headers": {
                                                                                        "Accept": "application/json",
                                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                                        "Content-Type": "application/json"
                                                                                    },
                                                                                    "method": "POST",
                                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                                },
                                                                                "runAfter": {
                                                                                    "Post_a_message_to_Teams_IR_channel_with_a_Link_to_the_IR_Tracker": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Http"
                                                                            },
                                                                            "Post_a_message_to_Teams_IR_channel_with_a_Link_to_the_IR_Tracker": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "body": {
                                                                                            "content": "<p><strong>Ticket:</strong><br>\n<strong>Title:</strong> <br>\n<strong>Alert ID: </strong><br>\n<strong>Severity: </strong><br>\n<strong>Alert Time:</strong><br>\n<strong>Alert Classification: </strong>&nbsp;@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}<br>\n<br>\nThe Incident Response Tracker is located <br>\n<br>\n<u><strong>Rule Description:</strong></u><br>\n<br>\n<br>\n<br>\n<u><strong>Additional Information:</strong></u><br>\n<br>\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}<br>\n<br>\n<strong>FAO </strong>Service Desk: Be prepared to supply replacement equipment and assist in Incident Response. For further information and guidance refer to the CIRP located here&nbsp;and the First Responders guide located here.&nbsp;</p>",
                                                                                            "contentType": "html"
                                                                                        },
                                                                                        "subject": "AP200-Sentinel Alert ID "
                                                                                    },
                                                                                    "host": {
                                                                                        "connection": {
                                                                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                                                                        }
                                                                                    },
                                                                                    "method": "post",
                                                                                    "path": "/v3/beta/teams/@{encodeURIComponent('9c5c01ec-1409-424a-a1d6-198b41b7b1c9')}/channels/@{encodeURIComponent('19:a2c93fb5fe104e689181510160df2515@thread.tacv2')}/messages"
                                                                                },
                                                                                "runAfter": {
                                                                                    "Update_Incident_with_Analyst_Findings_CSIRT_Positive2": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "ApiConnection"
                                                                            },
                                                                            "Update_Incident_with_Analyst_Findings_CSIRT_Positive2": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "Value": "The CSIRT have been alerted to this incident. The IR  Lead is @{body('Ticket_Closure_or_CSIRT_assistance_request')?['data']?['ir Lead']} \n and the CSIRT Lead is @{body('Ticket_Closure_or_CSIRT_assistance_request')?['data']?['csirt Lead']}."
                                                                                    },
                                                                                    "host": {
                                                                                        "connection": {
                                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                        }
                                                                                    },
                                                                                    "method": "put",
                                                                                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}"
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "ApiConnection"
                                                                            },
                                                                            "Update_PowerBi_Data_CSIRT_Required_2": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                                                                        "Alert Source": "AP200-Sentinel-DSS",
                                                                                        "CSIRT Lead": "@body('Ticket_Closure_or_CSIRT_assistance_request')?['data']?['csirt Lead']",
                                                                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                                                                        "False / True Positive": "@body('True,_False,_Benign_or_Assign')['submitActionId']",
                                                                                        "IR Lead": "@body('Ticket_Closure_or_CSIRT_assistance_request')?['data']?['ir Lead']",
                                                                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                                                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                                                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                                                                    },
                                                                                    "host": {
                                                                                        "connection": {
                                                                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                                                                        }
                                                                                    },
                                                                                    "method": "post",
                                                                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                                                                    "queries": {
                                                                                        "pbi_source": "powerAutomate"
                                                                                    }
                                                                                },
                                                                                "runAfter": {
                                                                                    "API_to_Investigate_Escalated_Incident_CSIRT_Required_2_": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "ApiConnection"
                                                                            }
                                                                        },
                                                                        "case": "Require CSIRT"
                                                                    }
                                                                },
                                                                "default": {
                                                                    "actions": {}
                                                                },
                                                                "expression": "@body('Ticket_Closure_or_CSIRT_assistance_request')['submitActionId']",
                                                                "runAfter": {
                                                                    "Ticket_Closure_or_CSIRT_assistance_request": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Switch"
                                                            },
                                                            "Forensic_Machine": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "body": {
                                                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Do you require a Forensic Machine\"\n    },\n],\n\"actions\": [\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Yes\",\n    },\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"No\",\n    },\n]\n}",
                                                                            "recipient": {
                                                                                "to": "@body('True,_False,_Benign_or_Assign')?['responder']?['email']"
                                                                            }
                                                                        },
                                                                        "notificationUrl": "@{listCallbackUrl()}"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                                                        }
                                                                    },
                                                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                                                },
                                                                "runAfter": {
                                                                    "API_to_Update_Escalated_Incident_True_Positive_": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnectionWebhook"
                                                            },
                                                            "Ticket_Closure_or_CSIRT_assistance_request": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "body": {
                                                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Can this Incident be closed or do you require CSIRT assistance?\"\n    },\n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Ticket Update: Closure Reason / Further Investigation Reason.\"\n    },\n    {\n    \"type\": \"Input.Text\",\n    \"id\":  \"Ticket Update\",\n    \"placeholder\":  \"Ticket Update\",\n    \"maxLength\": 1000,\n    \"isMultiline\": true\n    },\n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"IR Lead\",\n    },\n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"IR Lead\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"mark.strachan@allpay.net\",\n          \"value\": \"mark.strachan@allpay.net\"\n    },\n    {\n          \"title\": \"lee.wilson@allpay.net\",\n          \"value\": \"lee.wilson@allpay.net\"\n    },\n    {\n          \"title\": \"greg.penrose@allpay.net\",\n          \"value\": \"greg.penrose@allpay.net\"\n    },\n    {\n          \"title\": \"mark.golder@allpay.net\",\n          \"value\": \"mark.golder@allpay.net\"\n    },\n],\n},\n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"CSIRT Lead\",\n    },\n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"CSIRT Lead\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"mark.strachan@allpay.net\",\n          \"value\": \"mark.strachan@allpay.net\"\n    },\n    {\n          \"title\": \"lee.wilson@allpay.net\",\n          \"value\": \"lee.wilson@allpay.net\"\n    },\n    {\n          \"title\": \"greg.penrose@allpay.net\",\n          \"value\": \"greg.penrose@allpay.net\"\n    },\n    {\n          \"title\": \"mark.golder@allpay.net\",\n          \"value\": \"mark.golder@allpay.net\"\n    },\n],\n},\n],\n\"actions\": [\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Close\",\n    },\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Require CSIRT\",\n    },\n]\n}",
                                                                            "recipient": {
                                                                                "to": "@body('True,_False,_Benign_or_Assign')?['responder']?['email']"
                                                                            }
                                                                        },
                                                                        "notificationUrl": "@{listCallbackUrl()}"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                                                        }
                                                                    },
                                                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                                                },
                                                                "runAfter": {
                                                                    "Yes_or_No": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnectionWebhook"
                                                            },
                                                            "Update_Incident_with_Analyst_Findings_True_Positive": {
                                                                "inputs": {
                                                                    "body": {
                                                                        "Value": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}"
                                                                },
                                                                "runAfter": {
                                                                    "Add_labels_to_incident_True_Positive": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection"
                                                            },
                                                            "Yes_or_No": {
                                                                "cases": {
                                                                    "No": {
                                                                        "actions": {
                                                                            "API_Update_Ticket_Forensic_Machine_Not_Required": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "actionType": {
                                                                                            "resolvingParameters": [
                                                                                                {
                                                                                                    "parameterName": "shortCode",
                                                                                                    "parameterValue": "INVESTIGATE"
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                                        "remarks": "Analyst: @{body('Forensic_Machine')?['responder']?['displayName']}\nForensic Machine Required: @{body('Forensic_Machine')['submitActionId']}"
                                                                                    },
                                                                                    "headers": {
                                                                                        "Accept": "application/json",
                                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                                        "Content-Type": "application/json"
                                                                                    },
                                                                                    "method": "POST",
                                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "Http"
                                                                            }
                                                                        },
                                                                        "case": "No"
                                                                    },
                                                                    "Yes": {
                                                                        "actions": {
                                                                            "API_Update_Ticket_Forensic_Machine_Required": {
                                                                                "inputs": {
                                                                                    "body": {
                                                                                        "actionType": {
                                                                                            "resolvingParameters": [
                                                                                                {
                                                                                                    "parameterName": "shortCode",
                                                                                                    "parameterValue": "INVESTIGATE"
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                                                        "remarks": "Analyst: @{body('Forensic_Machine')?['responder']?['displayName']}\nForensic Machine Required: @{body('Forensic_Machine')['submitActionId']}"
                                                                                    },
                                                                                    "headers": {
                                                                                        "Accept": "application/json",
                                                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                                                        "Content-Type": "application/json"
                                                                                    },
                                                                                    "method": "POST",
                                                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                                                },
                                                                                "runAfter": {},
                                                                                "type": "Http"
                                                                            }
                                                                        },
                                                                        "case": "Yes"
                                                                    }
                                                                },
                                                                "default": {
                                                                    "actions": {}
                                                                },
                                                                "expression": "@body('Forensic_Machine')['submitActionId']",
                                                                "runAfter": {
                                                                    "Forensic_Machine": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Switch"
                                                            }
                                                        },
                                                        "case": "True Positive"
                                                    }
                                                },
                                                "default": {
                                                    "actions": {}
                                                },
                                                "expression": "@body('True,_False,_Benign_or_Assign')['submitActionId']",
                                                "runAfter": {
                                                    "True,_False,_Benign_or_Assign": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Switch"
                                            },
                                            "True,_False,_Benign_or_Assign": {
                                                "inputs": {
                                                    "body": {
                                                        "body": {
                                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Cause of  Alert:\",\n    },\n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"Classification\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"Unknown\",\n          \"value\": \"Unknown\"\n    },\n    {\n          \"title\": \"N/A\",\n          \"value\": \"N/A\"\n    },\n    {\n          \"title\": \"Hardware / Software Failure\",\n          \"value\": \"Hardware / Software Failure\"\n    },\n    {\n          \"title\": \"User Error\",\n          \"value\": \"User Error\"\n    },\n    {\n          \"title\": \"Expected Behaviour\",\n          \"value\": \"Expected Behaviour\"\n    },\n    {\n          \"title\": \"Rule Missfire\",\n          \"value\": \"Rule Missfire\"\n    },\n    {\n          \"title\": \"Scan\",\n          \"value\": \"Scan\"\n    },\n    {\n          \"title\": \"Misconfiguration\",\n          \"value\": \"Misconfiguration\"\n    },\n    {\n          \"title\": \"Ransomware\",\n          \"value\": \"Ransomware\"\n    },\n    {\n          \"title\": \"Phishing\",\n          \"value\": \"Phishing\"\n    },\n    {\n          \"title\": \"Adware / PUP\",\n          \"value\": \"Adware / PUP\"\n    },\n    {\n          \"title\": \"Exfiltration\",\n          \"value\": \"Exfiltration\"\n    },\n    {\n          \"title\": \"Data Leak\",\n          \"value\": \"Data Leak\"\n    },\n    {\n          \"title\": \"Key Logger\",\n          \"value\": \"Key Logger\"\n    },\n    {\n          \"title\": \"DDoS\",\n          \"value\": \"DDoS\"\n    },\n  {\n          \"title\": \"C2\",\n          \"value\": \"C2\"\n    },    {\n          \"title\": \"Privilege Escalation\",\n          \"value\": \"Privilege Escalation\"\n    },\n    {\n          \"title\": \"Rogue AP\",\n          \"value\": \"Rogue AP\"\n    }\n]\n},\n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Additional Information\"\n    },\n    {\n    \"type\": \"Input.Text\",\n    \"id\":  \"Additional Info\",\n    \"placeholder\":  \"Additional Information\",\n    \"maxLength\": 2000,\n    \"isMultiline\": true\n    }\n],\n\"actions\": [\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"True Positive\",\n    },\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"False Positive\",\n    },\n  {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Benign Positive\",\n    },\n  {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Escalate\",\n    },\n  {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Assign to another department\",\n    },\n]\n}",
                                                            "recipient": {
                                                                "to": "@body('Mesage_to_Analyst_assigned_incident_for_further_investigation')?['responder']?['email']"
                                                            }
                                                        },
                                                        "notificationUrl": "@{listCallbackUrl()}"
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                                        }
                                                    },
                                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                                },
                                                "runAfter": {
                                                    "API_Update_Ticket_with_assigned_Acknowledgement_of_Analyst": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "ApiConnectionWebhook"
                                            },
                                            "Update_Sentinel_Incident": {
                                                "inputs": {
                                                    "body": {
                                                        "Value": "@{body('Mesage_to_Analyst_assigned_incident_for_further_investigation')?['responder']?['userPrincipalName']} has Acknowdged receipt of Ticket Escalation at @{body('Mesage_to_Analyst_assigned_incident_for_further_investigation')['responseTime']}."
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                        }
                                                    },
                                                    "method": "put",
                                                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}"
                                                },
                                                "runAfter": {},
                                                "type": "ApiConnection"
                                            }
                                        },
                                        "case": "Acknowledge"
                                    }
                                },
                                "default": {
                                    "actions": {}
                                },
                                "expression": "@body('Mesage_to_Analyst_assigned_incident_for_further_investigation')['submitActionId']",
                                "runAfter": {
                                    "Mesage_to_Analyst_assigned_incident_for_further_investigation": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Switch"
                            },
                            "Mesage_to_Analyst_assigned_incident_for_further_investigation": {
                                "inputs": {
                                    "body": {
                                        "body": {
                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"You have been assigned Ticket number: This Ticket requires further Investigation.\",\n    },\n]\n},\n],\n\"actions\": [\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Acknowledge\",\n    },\n]\n}",
                                            "recipient": {
                                                "to": "@body('Select_the_analyst_to_be_escalated_to')?['data']?['escalation']"
                                            }
                                        },
                                        "notificationUrl": "@{listCallbackUrl()}"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                        }
                                    },
                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                },
                                "runAfter": {
                                    "Send_an_email_(V2)_4": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnectionWebhook"
                            },
                            "Select_the_analyst_to_be_escalated_to": {
                                "inputs": {
                                    "body": {
                                        "body": {
                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"Escalation\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"mark.strachan@allpay.net\",\n          \"value\": \"mark.strachan@allpay.net\"\n    },\n    {\n          \"title\": \"lee.wilson@allpay.net\",\n          \"value\": \"lee.wilson@allpay.net\"\n    },\n    {\n          \"title\": \"greg.penrose@allpay.net\",\n          \"value\": \"greg.penrose@allpay.net\"\n    },\n    {\n          \"title\": \"mark.golder@allpay.net\",\n          \"value\": \"mark.golder@allpay.net\"\n    },\n],\n},\n],\n\"actions\": [\n\t{\n    \"type\": \"Action.Submit\",\n    \"title\": \"Submit for Escalation\",\n    },\n]\n}",
                                            "recipient": {
                                                "to": "@{body('Create_an_Acknowledge_button_for_Analyst')?['responder']?['email']}"
                                            }
                                        },
                                        "notificationUrl": "@{listCallbackUrl()}"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                        }
                                    },
                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                },
                                "runAfter": {},
                                "type": "ApiConnectionWebhook"
                            },
                            "Send_an_email_(V2)_4": {
                                "inputs": {
                                    "body": {
                                        "Body": "<p>You have been assigned Incident ID  under Ticket: for further investigation.<strong><br>\n<br>\nAssigning Analyst: </strong><strong></strong><strong><br>\nTitle: </strong><br>\n<strong>Alert ID:</strong> <br>\n<strong>Severity:</strong> <br>\n<strong>Alert Time:</strong><br>\n<strong>Alert Classification:</strong> &nbsp;@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}<br>\n<br>\n<u><strong>Rule Description:</strong></u><br>\n<br>\n<br>\n<br>\n<u><strong>Additional Information:</strong></u><br>\n<br>\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}</p>",
                                        "From": "cybersecurity@allpay.net",
                                        "Subject": "AP200 - Sentinel Alert ID ",
                                        "To": "@body('Select_the_analyst_to_be_escalated_to')?['data']?['escalation']"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['office365']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/v2/Mail"
                                },
                                "runAfter": {
                                    "Add_comment_to_incident_(V2)_4": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            }
                        },
                        "case": "Escalate"
                    },
                    "False_Positive": {
                        "actions": {
                            "API_Ticket_Close_False_Positive": {
                                "inputs": {
                                    "body": {
                                        "actionType": {
                                            "resolvingParameters": [
                                                {
                                                    "parameterName": "shortCode",
                                                    "parameterValue": "CLOSURE"
                                                }
                                            ]
                                        },
                                        "causeCategoryId": "338",
                                        "causeItemId": "4060",
                                        "eventId": "@{outputs('Ticket_ID')}",
                                        "remarks": "Analyst: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['responder']?['displayName']}\nAnalyst Decision: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']}\nAnalyst Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}\n\nAnalsyt Reason for Closure: \n\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}"
                                    },
                                    "headers": {
                                        "Accept": "application/json",
                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                        "Content-Type": "application/json"
                                    },
                                    "method": "POST",
                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                },
                                "runAfter": {
                                    "Add_comment_to_incident_2": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Http"
                            },
                            "Add_comment_to_incident_2": {
                                "inputs": {
                                    "body": {
                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                        "message": "<p><br>\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}</p>"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                },
                                "runAfter": {
                                    "Change_incident_status_3": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Add_rows_to_a_dataset_2": {
                                "inputs": {
                                    "body": {
                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                        "Alert Source": "AP200-Sentinel-DSS",
                                        "Analyst Classification": "@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}",
                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                        "False / True Positive": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']",
                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                        }
                                    },
                                    "method": "post",
                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                    "queries": {
                                        "pbi_source": "powerAutomate"
                                    }
                                },
                                "runAfter": {
                                    "API_Ticket_Close_False_Positive": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Change_incident_status_3": {
                                "inputs": {
                                    "body": {
                                        "CloseReason": "FalsePositive",
                                        "CloseReasonText": "Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}  "
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('Closed')}"
                                },
                                "runAfter": {},
                                "type": "ApiConnection"
                            }
                        },
                        "case": "False Positive"
                    },
                    "True_Positive": {
                        "actions": {
                            "API_Ticket_Update_True_Positive": {
                                "inputs": {
                                    "body": {
                                        "actionType": {
                                            "resolvingParameters": [
                                                {
                                                    "parameterName": "shortCode",
                                                    "parameterValue": "INVESTIGATE"
                                                }
                                            ]
                                        },
                                        "eventId": "@{outputs('Ticket_ID')}",
                                        "remarks": "Analyst: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['responder']?['displayName']}\nAnalyst Decision: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']}\nAnalyst Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}\n\nAnalsyt Reason for True Positive: \n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}"
                                    },
                                    "headers": {
                                        "Accept": "application/json",
                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                        "Content-Type": "application/json"
                                    },
                                    "method": "POST",
                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                },
                                "runAfter": {
                                    "Add_comment_to_incident_(V2)_7": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Http"
                            },
                            "Add_comment_to_incident_(V2)_7": {
                                "inputs": {
                                    "body": {
                                        "Value": " @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}"
                                },
                                "runAfter": {
                                    "Add_labels_to_incident_4": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnection"
                            },
                            "Add_labels_to_incident_4": {
                                "inputs": {
                                    "body": {
                                        "Labels": [
                                            {
                                                "Label": "Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}"
                                            },
                                            {
                                                "Label": "Analyst Decision: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']}"
                                            },
                                            {
                                                "Label": null
                                            }
                                        ]
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                        }
                                    },
                                    "method": "put",
                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/AddLabels"
                                },
                                "runAfter": {},
                                "type": "ApiConnection"
                            },
                            "Close_or_request_CSIRT": {
                                "cases": {
                                    "Close": {
                                        "actions": {
                                            "API_Ticket_Close_True_Positive": {
                                                "inputs": {
                                                    "body": {
                                                        "actionType": {
                                                            "resolvingParameters": [
                                                                {
                                                                    "parameterName": "shortCode",
                                                                    "parameterValue": "CLOSURE"
                                                                }
                                                            ]
                                                        },
                                                        "causeCategoryId": "338",
                                                        "causeItemId": "4060",
                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                        "remarks": "Analyst: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['responder']?['displayName']}\nAnalyst Decision: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']}\nAnalyst Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}\n\nAnalsyt Reason for Closure: \n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}"
                                                    },
                                                    "headers": {
                                                        "Accept": "application/json",
                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                        "Content-Type": "application/json"
                                                    },
                                                    "method": "POST",
                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                },
                                                "runAfter": {
                                                    "Add_comment_to_incident_3": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http"
                                            },
                                            "Add_comment_to_incident_3": {
                                                "inputs": {
                                                    "body": {
                                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                        "message": "<p>@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}<br>\n<br>\n@{body('Close_the_Ticket_or_Require_CSIRT_Assistance')?['data']?['ticket Update']}</p>"
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/Incidents/Comment"
                                                },
                                                "runAfter": {
                                                    "Change_incident_status_7": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "ApiConnection"
                                            },
                                            "Add_rows_to_a_dataset_9": {
                                                "inputs": {
                                                    "body": {
                                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                                        "Alert Source": "AP200-Sentinel-DSS",
                                                        "Analyst Classification": "@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}",
                                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                                        "False / True Positive": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']",
                                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                                    "queries": {
                                                        "pbi_source": "powerAutomate"
                                                    }
                                                },
                                                "runAfter": {
                                                    "API_Ticket_Close_True_Positive": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "ApiConnection"
                                            },
                                            "Change_incident_status_7": {
                                                "inputs": {
                                                    "body": {
                                                        "CloseReason": "TruePositive",
                                                        "CloseReasonText": "Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}  "
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                        }
                                                    },
                                                    "method": "put",
                                                    "path": "/Case/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Incident')}/@{encodeURIComponent(body('Alert_-_Get_incident')?['properties']?['incidentNumber'])}/Status/@{encodeURIComponent('Closed')}"
                                                },
                                                "runAfter": {},
                                                "type": "ApiConnection"
                                            }
                                        },
                                        "case": "Close"
                                    },
                                    "Require_CSIRT": {
                                        "actions": {
                                            "API_Update_Ticket_CSIRT": {
                                                "inputs": {
                                                    "body": {
                                                        "actionType": {
                                                            "resolvingParameters": [
                                                                {
                                                                    "parameterName": "shortCode",
                                                                    "parameterValue": "INVESTIGATE"
                                                                }
                                                            ]
                                                        },
                                                        "causeCategoryId": "338",
                                                        "causeItemId": "4060",
                                                        "eventId": "@{outputs('Ticket_ID')}",
                                                        "remarks": "Analyst: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['responder']?['displayName']}\nAnalyst Decision: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']}\nAnalyst Classification: @{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}\nIR Lead: @{body('Close_the_Ticket_or_Require_CSIRT_Assistance')?['data']?['ir Lead']}\nCSIRT Lead: @{body('Close_the_Ticket_or_Require_CSIRT_Assistance')?['data']?['csirt Lead']}\n\nAnalsyt Reason for CSIRT: @{body('Close_the_Ticket_or_Require_CSIRT_Assistance')?['data']?['ticket Update']}\n"
                                                    },
                                                    "headers": {
                                                        "Accept": "application/json",
                                                        "Authorization": "Basic MTYxMTkxLWFzc3lzdHJlc3Q6UmVpbmNhcm5hdGVNdW5pdGlvbnNUd2lubmVkM8KjOCMwPg==",
                                                        "Content-Type": "application/json"
                                                    },
                                                    "method": "POST",
                                                    "uri": "https://servicedesk.allpay.net/assystREST/v2/actions"
                                                },
                                                "runAfter": {
                                                    "Add_comment_to_incident_4": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http"
                                            },
                                            "Add_comment_to_incident_4": {
                                                "inputs": {
                                                    "body": {
                                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                        "message": "<p>@{body('Close_the_Ticket_or_Require_CSIRT_Assistance')?['data']?['ticket Update']}</p>"
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/Incidents/Comment"
                                                },
                                                "runAfter": {
                                                    "Post_a_message_(V3)_2": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "ApiConnection"
                                            },
                                            "Add_rows_to_a_dataset_10": {
                                                "inputs": {
                                                    "body": {
                                                        "Alert ID - Sentinel": "@{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}",
                                                        "Alert Source": "AP200-Sentinel-DSS",
                                                        "Analyst Classification": "@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}",
                                                        "CSIRT Lead": "@body('Close_the_Ticket_or_Require_CSIRT_Assistance')?['data']?['csirt Lead']",
                                                        "Date": "@body('Alert_-_Get_incident')?['properties']?['createdTimeUtc']",
                                                        "False / True Positive": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']",
                                                        "IR Lead": "@body('Close_the_Ticket_or_Require_CSIRT_Assistance')?['data']?['ir Lead']",
                                                        "Severity - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['severity']",
                                                        "Ticket Number": "@{outputs('Ticket_Number_eventRef')}",
                                                        "Title - Sentinel": "@body('Alert_-_Get_incident')?['properties']?['title']"
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['powerbi']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/v1.0/myorg/groups/@{encodeURIComponent('391c0db3-9d39-467e-926d-dbedb0b9d38c')}/datasets/@{encodeURIComponent('555959dc-0ac0-45d8-a97f-9c07563bad55')}/tables/@{encodeURIComponent('RealTimeData')}/rows",
                                                    "queries": {
                                                        "pbi_source": "powerAutomate"
                                                    }
                                                },
                                                "runAfter": {
                                                    "API_Update_Ticket_CSIRT": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "ApiConnection"
                                            },
                                            "Post_a_message_(V3)_2": {
                                                "inputs": {
                                                    "body": {
                                                        "body": {
                                                            "content": "<p><strong>Ticket:<br>\nTitle: </strong><strong></strong><strong><br>\nAlert ID</strong>: <br>\n<strong>Severity: </strong><br>\n<strong>Alert Time:</strong><br>\n<strong>Alert Classification: </strong>&nbsp;@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['classification']}<br>\n<br>\nThe Incident Response Tracker is located <a href=\"https://allpay.sharepoint.com/:x:/r/sites/CyberSecurity/SOC/SOC%20Incident%20Response/Incident-Response-Tracker.xlsx?d=wee3e5522f6fd4c2ba063cea7609ed4a6&amp;csf=1&amp;web=1&amp;e=3L1YWm\">here</a><br>\n<br>\nRule Description:<br>\n<br>\n<br>\n<br>\nAdditional Information:<br>\n<br>\n@{body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['data']?['additional Info']}<br>\n<br>\n@{body('Close_the_Ticket_or_Require_CSIRT_Assistance')?['data']?['ticket Update']}<br>\n<br>\nFAO Service Desk: Be prepared to supply replacement equipment and assist in Incident Response. For further information and guidance refer to the CIRP located here&nbsp;and the First Responders guide located here.&nbsp;</p>",
                                                            "contentType": "html"
                                                        },
                                                        "subject": "AP200-Sentinel Alert ID "
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/v3/beta/teams/@{encodeURIComponent('9c5c01ec-1409-424a-a1d6-198b41b7b1c9')}/channels/@{encodeURIComponent('19:a2c93fb5fe104e689181510160df2515@thread.tacv2')}/messages"
                                                },
                                                "runAfter": {},
                                                "type": "ApiConnection"
                                            }
                                        },
                                        "case": "Require CSIRT"
                                    }
                                },
                                "default": {
                                    "actions": {}
                                },
                                "expression": "@body('Close_the_Ticket_or_Require_CSIRT_Assistance')['submitActionId']",
                                "runAfter": {
                                    "Close_the_Ticket_or_Require_CSIRT_Assistance": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Switch"
                            },
                            "Close_the_Ticket_or_Require_CSIRT_Assistance": {
                                "inputs": {
                                    "body": {
                                        "body": {
                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Can this Incident be closed or do you require CSIRT assistance?\"\n    },\n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Ticket Update: Closure Reason / Further Investigation Reason.\"\n    },\n    {\n    \"type\": \"Input.Text\",\n    \"id\":  \"Ticket Update\",\n    \"placeholder\":  \"Ticket Update\",\n    \"maxLength\": 1000,\n    \"isMultiline\": true\n    },\n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"IR Lead\",\n    },\n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"IR Lead\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"mark.strachan@allpay.net\",\n          \"value\": \"mark.strachan@allpay.net\"\n    },\n    {\n          \"title\": \"lee.wilson@allpay.net\",\n          \"value\": \"lee.wilson@allpay.net\"\n    },\n    {\n          \"title\": \"greg.penrose@allpay.net\",\n          \"value\": \"greg.penrose@allpay.net\"\n    },\n    {\n          \"title\": \"mark.golder@allpay.net\",\n          \"value\": \"mark.golder@allpay.net\"\n    },\n],\n},\n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"CSIRT Lead\",\n    },\n{\n    \"type\": \"Input.ChoiceSet\",\n    \"id\":  \"CSIRT Lead\",\n    \"style\":  \"compact\",\n    \"isMultiSelect\": false,\n    \"value\": \"1\",\n    \"choices\": [\n    {\n          \"title\": \"mark.strachan@allpay.net\",\n          \"value\": \"mark.strachan@allpay.net\"\n    },\n    {\n          \"title\": \"lee.wilson@allpay.net\",\n          \"value\": \"lee.wilson@allpay.net\"\n    },\n    {\n          \"title\": \"greg.penrose@allpay.net\",\n          \"value\": \"greg.penrose@allpay.net\"\n    },\n    {\n          \"title\": \"mark.golder@allpay.net\",\n          \"value\": \"mark.golder@allpay.net\"\n    },\n],\n},\n],\n\"actions\": [\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Close\",\n    },\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Require CSIRT\",\n    },\n]\n}",
                                            "recipient": {
                                                "to": "@body('Forensic_Machine_Request')?['responder']?['email']"
                                            }
                                        },
                                        "notificationUrl": "@{listCallbackUrl()}"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                        }
                                    },
                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                },
                                "runAfter": {
                                    "Yes_or_No_-_1": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnectionWebhook"
                            },
                            "Forensic_Machine_Request": {
                                "inputs": {
                                    "body": {
                                        "body": {
                                            "messageBody": "{\n\"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n\"type\": \"AdaptiveCard\",\n\"version\": \"1.0\",\n\"body\": [\n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"@{body('Alert_-_Get_incident')?['properties']?['title']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Assyst Ticket: @{outputs('Ticket_Number_eventRef')}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\": \"Alert ID: @{body('Alert_-_Get_incident')?['properties']?['incidentNumber']}\",\n    \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n    \"type\": \"TextBlock\",\n    \"text\":  \"Severity: @{body('Alert_-_Get_incident')?['properties']?['severity']}\",\n     \"size\": \"large\",\n    \"weight\": \"bolder\",\n    }, \n    {\n      \"type\": \"TextBlock\",\n      \"text\": \"Do you require a Forensic Machine\"\n    },\n],\n\"actions\": [\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"Yes\",\n    },\n    {\n    \"type\": \"Action.Submit\",\n    \"title\": \"No\",\n    },\n]\n}",
                                            "recipient": {
                                                "to": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')?['responder']?['email']"
                                            }
                                        },
                                        "notificationUrl": "@{listCallbackUrl()}"
                                    },
                                    "host": {
                                        "connection": {
                                            "name": "@parameters('$connections')['teams']['connectionId']"
                                        }
                                    },
                                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/user/$subscriptions"
                                },
                                "runAfter": {
                                    "API_Ticket_Update_True_Positive": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "ApiConnectionWebhook"
                            },
                            "Yes_or_No_-_1": {
                                "cases": {
                                    "No": {
                                        "actions": {},
                                        "case": "No"
                                    },
                                    "Yes": {
                                        "actions": {},
                                        "case": "Yes"
                                    }
                                },
                                "default": {
                                    "actions": {}
                                },
                                "expression": "@body('Forensic_Machine_Request')['submitActionId']",
                                "runAfter": {
                                    "Forensic_Machine_Request": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Switch"
                            }
                        },
                        "case": "True Positive"
                    }
                },
                "default": {
                    "actions": {}
                },
                "expression": "@body('Analyst_decision_process_(True_-_False_Positive_or_escalate)')['submitActionId']",
                "runAfter": {
                    "Analyst_decision_process_(True_-_False_Positive_or_escalate)": [
                        "Succeeded"
                    ]
                },
                "type": "Switch"
            }
        },
        "contentVersion": "1.0.0.0",
        "outputs": {},
        "parameters": {
            "$connections": {
                "defaultValue": {},
                "type": "Object"
            }
        },
        "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                "inputs": {
                    "body": {
                        "callback_url": "@{listCallbackUrl()}"
                    },
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['azuresentinel_1']['connectionId']"
                        }
                    },
                    "path": "/subscribe"
                },
                "type": "ApiConnectionWebhook"
            }
        }
    },
    "parameters": {
        "$connections": {
            "value": {
                "azuresentinel": {
                    "connectionId": "/subscriptions/f167fded-0657-4c54-a292-4746df848a4b/resourceGroups/Sentinel-Test-Site/providers/Microsoft.Web/connections/azuresentinel",
                    "connectionName": "azuresentinel",
                    "id": "/subscriptions/f167fded-0657-4c54-a292-4746df848a4b/providers/Microsoft.Web/locations/uksouth/managedApis/azuresentinel"
                },
                "office365": {
                    "connectionId": "/subscriptions/f167fded-0657-4c54-a292-4746df848a4b/resourceGroups/Sentinel-Test-Site/providers/Microsoft.Web/connections/office365",
                    "connectionName": "office365",
                    "id": "/subscriptions/f167fded-0657-4c54-a292-4746df848a4b/providers/Microsoft.Web/locations/uksouth/managedApis/office365"
                },
                "powerbi": {
                    "connectionId": "/subscriptions/f167fded-0657-4c54-a292-4746df848a4b/resourceGroups/Sentinel-Test-Site/providers/Microsoft.Web/connections/powerbi",
                    "connectionName": "powerbi",
                    "id": "/subscriptions/f167fded-0657-4c54-a292-4746df848a4b/providers/Microsoft.Web/locations/uksouth/managedApis/powerbi"
                },
                "teams": {
                    "connectionId": "/subscriptions/f167fded-0657-4c54-a292-4746df848a4b/resourceGroups/Sentinel-Test-Site/providers/Microsoft.Web/connections/teams",
                    "connectionName": "teams",
                    "id": "/subscriptions/f167fded-0657-4c54-a292-4746df848a4b/providers/Microsoft.Web/locations/uksouth/managedApis/teams"

                }
            }
        }
    }
}
}
  ]

}